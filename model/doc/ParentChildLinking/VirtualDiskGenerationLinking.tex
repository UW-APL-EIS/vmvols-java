% How VMware/Vbox link parent and child Virtual Disks.

\documentclass{article}

%\title[Stuart 1 XJC 0]{How I fought with XJC and won!}
\title{Virtual Disk Generation Linking}

\author{Stuart Maclean \\
Applied Physics Laboratory \\
University of Washington}

%\texttt{stuart@apl.uw.edu}}


\date{October 2015}

\begin{document}

\maketitle

\section{Introduction}

See also the VMWare 'vmdk\_specs.pdf' file, which contains a
field-by-field description of the VMWare 'Descriptor File' format.

\section{Virtual Box VDI Files}

\section{VMWare VMDK Files}

 VMDKFile metadata produced by vmvols tool 'vmdkinfo'.  Prints
 SparseExtentHeader and Descriptor info at head of any .vmdk file.

We have examples of various standalone (single generation) and
parent-child relationships across .vmdk files where

\begin{itemize}
\item both initial disk and snapshot
  created within a VMWare host-based product, e.g. Workstation.

\item both initial disk and snapshot
  created within VirtualBox, using the .vmdk hard drive file type (and
  not the native VDI format)

\item the initial disk is via an VirtualBox import operation of an ovf
  package.

\item we also examine the streamOptimized vmdk file variant used in
  ovf/ova packages (an output of e.g. packer)
\end{itemize}

\subsection{Example Disk 1}

First generation of a virtual machine hard drive. VM generated by
VMWare Workstation Pro 12 (trial edition), Oct 2015.

\begin{verbatim}
$ vmdkinfo ~/vmware/Windows\ 7\ x64/Windows\ 7\ x64.vmdk 

Flags: 00000003
Version: 1
Capacity: 125829120
GrainSize: 128
DescriptorOffset: 1
DescriptorSize: 20
NumGTEsPerGT: 512
rgdOffset: 21
gdOffset: 7716
Overhead: 15488
Compression: 0

# Disk DescriptorFile
version=1
encoding="UTF-8"
CID=7c77be3e
parentCID=ffffffff
isNativeSnapshot="no"
createType="monolithicSparse"

# Extent description
RW 125829120 SPARSE "Windows 7 x64.vmdk"

# The Disk Data Base 
#DDB

ddb.adapterType = "lsilogic"
ddb.geometry.cylinders = "7832"
ddb.geometry.heads = "255"
ddb.geometry.sectors = "63"
ddb.longContentID = "998e1e01d9a37fe7ae03f9e17c77be3e"
ddb.uuid = "60 00 C2 92 c7 b3 76 ce-43 c5 92 ee 09 64 6c 58"
ddb.virtualHWVersion = "12"
\end{verbatim}

\subsection{Example Disk 2}

Snapshot (second generation) of the virtual machine hard drive
above. VM generated by VMWare Workstation Pro 12 (trial edition), Oct
2015.  Note how little/vague the 'parent pointer' is, just a 'hint' in
the descriptor.
  
\begin{verbatim}
$ vmdkinfo ~/vmware/Windows\ 7\ x64/Windows\ 7\ x64-000001.vmdk 

Flags: 00000003
Version: 1
Capacity: 125829120
GrainSize: 128
DescriptorOffset: 1
DescriptorSize: 20
NumGTEsPerGT: 512
rgdOffset: 21
gdOffset: 7716
Overhead: 15488
Compression: 0

# Disk DescriptorFile
version=1
encoding="UTF-8"
CID=7c77be3e
parentCID=7c77be3e
isNativeSnapshot="no"
createType="monolithicSparse"
parentFileNameHint="/home/stuart/vmware/Windows 7 x64/Windows 7 x64.vmdk"
# Extent description
RW 125829120 SPARSE "Windows 7 x64-000001.vmdk"

# The Disk Data Base 
#DDB

ddb.adapterType = "lsilogic"
ddb.geometry.cylinders = "7832"
ddb.geometry.heads = "255"
ddb.geometry.sectors = "63"
ddb.longContentID = "998e1e01d9a37fe7ae03f9e17c77be3e"
ddb.uuid = "60 00 C2 92 c7 b3 76 ce-43 c5 92 ee 09 64 6c 58"
ddb.virtualHWVersion = "12"
\end{verbatim}

Heuristic: If descriptor has parentFileNameHint=entry, use it in locating
a parent.  The CID and parentCID in the child are equal, and both are
equal to the CID in the parent file.  Use this fact as an extra check?

\subsection{Example Disk 3}

Standalone vmdk produced by packer (v0.8.6) with a 'virtualbox-iso'
builder.  Note that even though the configuration is for virtualBox,
the file format for the virtual disk is a .vmdk.  Th
Note how the createType is 'streamOptimized'.  .vmdk is associated
with a .ovf file (found alongside the .vmdk).

\begin{verbatim}
$ ./vmdkinfo ~/apl/projects/infosec/packer-vms/ubuntu-12.04.4-amd64/base/products/ubuntu-12.04.5-amd64-base-disk1.vmdk 

Flags: 00030001
Version: 3
Capacity: 81920000
GrainSize: 128
DescriptorOffset: 1
DescriptorSize: 2
NumGTEsPerGT: 512
rgdOffset: 0
gdOffset: -1
Overhead: 128
Compression: 1

# Disk DescriptorFile
version=1
CID=9f5528be
parentCID=ffffffff
createType="streamOptimized"

# Extent description
RDONLY 81920000 SPARSE "ubuntu-12.04.5-amd64-base-disk1.vmdk"

# The disk Data Base 
#DDB

ddb.virtualHWVersion = "4"
ddb.adapterType="ide"
ddb.geometry.cylinders="16383"
ddb.geometry.heads="16"
ddb.geometry.sectors="63"
ddb.geometry.biosCylinders="1024"
ddb.geometry.biosHeads="255"
ddb.geometry.biosSectors="63"
ddb.uuid.image="ba1d7b83-2e83-4777-90fb-61c8251ccd69"
ddb.uuid.parent="00000000-0000-0000-0000-000000000000"
ddb.uuid.modification="00000000-0000-0000-0000-000000000000"
ddb.uuid.parentmodification="00000000-0000-0000-0000-000000000000"
ddb.comment=""
\end{verbatim}

Note the ddb.uuid.* entries in the DDB section.  Not sure what these
are for?

Recall that this streamOptimized form of VMDK file is suitable for
OVF/OVA packages but not for direct attachment into a VM.  Instead,
its OVF/OVA package must be first imported by the VM engine.  The
import process reads the streamOptimized input, but writes e.g. a
monolithicSparse version locally as the VM's actual virtual disk
format.

\subsection{Example Disk 4}

Created in/by VirtualBox, but by selecting 'VMDK' as the 'Hard Drive
Format Type' in the VM creation wizard.

\begin{verbatim}
$ ./vmdkinfo  ~/VirtualBox\ VMs/Blank_VMDK/Blank_VMDK.vmdk 

Flags: 00000003
Version: 1
Capacity: 268435456
GrainSize: 128
DescriptorOffset: 1
DescriptorSize: 20
NumGTEsPerGT: 512
rgdOffset: 21
gdOffset: 16437
Overhead: 32896
Compression: 0

# Disk DescriptorFile
version=1
CID=fe21c26a
parentCID=ffffffff
createType="monolithicSparse"

# Extent description
RW 268435456 SPARSE "Blank_VMDK.vmdk"

# The disk Data Base 
#DDB

ddb.virtualHWVersion = "4"
ddb.adapterType="ide"
ddb.uuid.image="c86e611c-1092-48b0-b257-3e9480018efa"
ddb.uuid.parent="00000000-0000-0000-0000-000000000000"
ddb.uuid.modification="00000000-0000-0000-0000-000000000000"
ddb.uuid.parentmodification="00000000-0000-0000-0000-000000000000"
\end{verbatim}

\subsection{Example Disk 5}

A snapshot, taken by/in VirtualBox, of the .vmdk file described above
(Example 4):

\begin{verbatim}
$ ./vmdkinfo  ~/VirtualBox\ VMs/Blank_VMDK/Snapshots/\{b23c64d7-e938-4f7b-bc80-c56f4390dfe7\}.vmdk 

Flags: 00000003
Version: 1
Capacity: 268435456
GrainSize: 128
DescriptorOffset: 1
DescriptorSize: 20
NumGTEsPerGT: 512
rgdOffset: 21
gdOffset: 16437
Overhead: 32896
Compression: 0

# Disk DescriptorFile
version=1
CID=f5050853
parentCID=ffffffff
createType="monolithicSparse"

# Extent description
RW 268435456 SPARSE "{b23c64d7-e938-4f7b-bc80-c56f4390dfe7}.vmdk"

# The disk Data Base 
#DDB

ddb.virtualHWVersion = "4"
ddb.adapterType="ide"
ddb.uuid.image="b23c64d7-e938-4f7b-bc80-c56f4390dfe7"
ddb.uuid.parent="c86e611c-1092-48b0-b257-3e9480018efa"
ddb.uuid.modification="00000000-0000-0000-0000-000000000000"
ddb.uuid.parentmodification="00000000-0000-0000-0000-000000000000"
\end{verbatim}

Note how the CID and parentCID in this descriptor do {\em not} given
any hint on how to locate/identify the parent. The CIDs of the example
disks 4 and 5 appear unrelated.

What {\em is} useful are the ddb.uuid.* entries, which VirtualBox
seems to use whereas VMware products do not.  The parent-child
relationship between example disk 4 and 5 can be seen in the
uuid.parent of disk 5 and uuid.image of disk 4.  Recall that in
VirtualBox's native VDI format, uuidImage and uuidParent are both
fields present in the 'VDI header', so it's almost as if VirtualBox
are shoe-horning their own parent/child linking info idea into a VMDK
Descriptor file.


Heuristic: If descriptor has ddb.uuid.parent entry, use it in locating
a parent.  Such a parent will have a ddb.uuid.image descriptor entry
whose value matches the uuid.parent entry in the child.


\subsection{Example Disk 6}

VirtualBox import of the OVF package created for Example Disk 3:

\begin{verbatim}
$ ./vmdkinfo ~/VirtualBox\ VMs/ubuntu-12.04.5-amd64-base/ubuntu-12.04.5-amd64-base-disk1.vmdk 

Flags: 00000003
Version: 1
Capacity: 81920000
GrainSize: 128
DescriptorOffset: 1
DescriptorSize: 20
NumGTEsPerGT: 512
rgdOffset: 21
gdOffset: 5031
Overhead: 10112
Compression: 0

# Disk DescriptorFile
version=1
CID=6704c82b
parentCID=ffffffff
createType="monolithicSparse"

# Extent description
RW 81920000 SPARSE "ubuntu-12.04.5-amd64-base-disk1.vmdk"

# The disk Data Base 
#DDB

ddb.virtualHWVersion = "4"
ddb.adapterType="ide"
ddb.geometry.cylinders="16383"
ddb.geometry.heads="16"
ddb.geometry.sectors="63"
ddb.geometry.biosCylinders="1024"
ddb.geometry.biosHeads="255"
ddb.geometry.biosSectors="63"
ddb.uuid.image="429e7834-80be-4bf5-a72f-a16c18cde00d"
ddb.uuid.parent="00000000-0000-0000-0000-000000000000"
ddb.uuid.modification="00000000-0000-0000-0000-000000000000"
ddb.uuid.parentmodification="00000000-0000-0000-0000-000000000000"
ddb.comment=""
\end{verbatim}

\end{document}

% eof
